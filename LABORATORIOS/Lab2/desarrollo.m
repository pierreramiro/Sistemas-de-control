%% Experiencia 1.a)Identificando zonas lineales
clc;
clear;
close all;


vel=[-438.08 -426.14 -407.61 -390.63 -375.00 -347.22 -327.80 -310.43 -284.09 -250.67 -226.45 -206.50 -182.39 -154.70 -126.35 -101.90 -74.17 -46.46 -20.49 -10.43 -10.43 -10.43 -10.43 47.93 74.40 99.73 123.36 147.41 174.26 196.13 218.02 240.38 261.87 298.57 330.11 352.44 375.00 397.25 418.53 438.08 464.11 ];
u= -4 : 0.2 : 4;


plot(u,vel);
grid
openfig('Zonas_lineales');
%% Exp1.b) Modelando las tf

t= 0: 0.002 : 0.999;
u=ones(1,500);
%zona 1. [-4,-3]. Escogemos u=-3.5
vel=[-110.55 -133.55 -150.24 -168.62 -183.11 -199.47 -210.20 -224.28 -240.38 -240.38 -253.38 -264.83 -272.53 -284.09 -292.97 -298.57 -310.43 -318.88 -298.57 -325.52 -330.11 -337.23 -342.15 -344.67 -352.44 -355.11 -360.58 -363.37 -369.09 -372.02 -375.00 -378.02 -381.10 -387.40 -387.40 -393.91 -397.25 -400.64 -404.09 -387.40 -400.64 -397.25 -404.09 -372.02 -411.18 -414.82 -414.82 -414.82 -411.18 -411.18 -418.53 -438.08 -422.30 -422.30 -414.82 -418.53 -418.53 -393.91 -426.14 -422.30 -422.30 -426.14 -430.05 -434.03 -434.03 -384.22 -426.14 -430.05 -434.03 -426.14 -430.05 -426.14 -426.14 -434.03 -438.08 -438.08 -426.14 -438.08 -418.53 -434.03 -430.05 -434.03 -434.03 -434.03 -438.08 -422.30 -434.03 -434.03 -438.08 -438.08 -434.03 -430.05 -434.03 -442.22 -434.03 -430.05 -422.30 -442.22 -442.22 -434.03 -434.03 -434.03 -438.08 -434.03 -434.03 -434.03 -438.08 -418.53 -438.08 -434.03 -434.03 -434.03 -438.08 -434.03 -434.03 -434.03 -404.09 -438.08 -438.08 -434.03 -430.05 -442.22 -438.08 -434.03 -434.03 -397.25 -438.08 -442.22 -430.05 -434.03 -442.22 -442.22 -434.03 -434.03 -434.03 -442.22 -407.61 -438.08 -434.03 -442.22 -442.22 -438.08 -400.64 -434.03 -434.03 -438.08 -442.22 -434.03 -442.22 -442.22 -404.09 -455.10 -434.03 -434.03 -442.22 -442.22 -438.08 -434.03 -442.22 -434.03 -442.22 -434.03 -434.03 -442.22 -446.43 -442.22 -434.03 -422.30 -446.43 -400.64 -442.22 -390.63 -442.22 -446.43 -446.43 -442.22 -446.43 -446.43 -438.08 -442.22 -442.22 -430.05 -442.22 -446.43 -438.08 -446.43 -459.56 -438.08 -442.22 -434.03 -442.22 -442.22 -418.53 -438.08 -446.43 -434.03 -442.22 -422.30 -438.08 -411.18 -446.43 -390.63 -434.03 -446.43 -426.14 -438.08 -422.30 -434.03 -442.22 -442.22 -442.22 -434.03 -442.22 -442.22 -438.08 -434.03 -434.03 -442.22 -442.22 -438.08 -434.03 -438.08 -442.22 -442.22 -438.08 -434.03 -438.08 -442.22 -404.09 -434.03 -442.22 -438.08 -442.22 -434.03 -434.03 -434.03 -397.25 -438.08 -426.14 -434.03 -446.43 -442.22 -430.05 -438.08 -438.08 -438.08 -430.05 -442.22 -434.03 -438.08 -446.43 -442.22 -434.03 -434.03 -438.08 -442.22 -442.22 -422.30 -442.22 -426.14 -442.22 -426.14 -434.03 -434.03 -446.43 -407.61 -438.08 -442.22 -446.43 -450.72 -438.08 -434.03 -438.08 -446.43 -442.22 -434.03 -442.22 -442.22 -442.22 -438.08 -434.03 -430.05 -446.43 -442.22 -434.03 -400.64 -446.43 -442.22 -434.03 -438.08 -426.14 -442.22 -442.22 -438.08 -434.03 -442.22 -434.03 -438.08 -438.08 -434.03 -442.22 -442.22 -434.03 -434.03 -442.22 -442.22 -426.14 -434.03 -434.03 -434.03 -442.22 -434.03 -400.64 -438.08 -442.22 -438.08 -434.03 -434.03 -430.05 -438.08 -434.03 -390.63 -430.05 -438.08 -438.08 -438.08 -434.03 -430.05 -434.03 -438.08 -393.91 -430.05 -434.03 -438.08 -442.22 -434.03 -438.08 -411.18 -442.22 -434.03 -438.08 -434.03 -438.08 -442.22 -438.08 -414.82 -430.05 -446.43 -442.22 -434.03 -434.03 -438.08 -446.43 -430.05 -434.03 -407.61 -442.22 -442.22 -434.03 -434.03 -434.03 -446.43 -446.43 -430.05 -442.22 -442.22 -438.08 -438.08 -434.03 -438.08 -446.43 -442.22 -438.08 -438.08 -442.22 -442.22 -438.08 -434.03 -438.08 -442.22 -446.43 -438.08 -438.08 -442.22 -442.22 -434.03 -434.03 -434.03 -442.22 -442.22 -422.30 -434.03 -442.22 -446.43 -438.08 -438.08 -434.03 -442.22 -442.22 -438.08 -438.08 -442.22 -446.43 -434.03 -438.08 -422.30 -438.08 -442.22 -442.22 -438.08 -438.08 -442.22 -442.22 -426.14 -434.03 -438.08 -442.22 -442.22 -438.08 -438.08 -442.22 -442.22 -434.03 -422.30 -438.08 -414.82 -442.22 -422.30 -434.03 -446.43 -442.22 -438.08 -434.03 -434.03 -442.22 -442.22 -446.43 -434.03 -404.09 -442.22 -390.63 -438.08 -397.25 -442.22 -442.22 -442.22 -438.08 -430.05 -446.43 -407.61 -442.22 -422.30 -438.08 -430.05 -446.43 -442.22 -422.30 -442.22 -438.08 -442.22 -442.22 -442.22 -446.43 -446.43 -438.08 -446.43 -455.10 -438.08 -442.22 -442.22 -450.72 -446.43 -438.08 -446.43 -446.43 -446.43 -442.22 -434.03 -426.14 -450.72 -446.43 -442.22 -442.22 -446.43 -450.72 -442.22 -438.08 -446.43 -446.43 -446.43 -434.03 -442.22 -446.43 -442.22 -442.22 -442.22 -430.05 -446.43 -442.22 -442.22 ];
vel1=vel(1:500);
u1= -3.5*u;

%zona 2. [-3,0]. Escogemos u=-1.5
vel=[-50.73 -64.30 -70.38 -79.86 -84.92 -92.27 -98.68 -102.12 -107.51 -109.78 -118.67 -119.88 -124.67 -129.49 -129.49 -132.04 -136.66 -137.87 -141.19 -142.91 -142.48 -149.76 -148.34 -153.19 -152.19 -155.22 -155.22 -155.73 -158.90 -156.77 -161.08 -157.83 -163.90 -161.08 -163.33 -163.33 -162.76 -163.90 -163.90 -166.81 -165.64 -168.01 -165.64 -170.45 -168.62 -171.08 -166.81 -172.33 -169.84 -172.97 -169.84 -172.33 -170.45 -172.33 -173.61 -172.33 -171.08 -166.81 -173.61 -171.70 -174.26 -172.33 -172.97 -172.33 -175.56 -172.33 -175.56 -172.33 -175.56 -172.33 -176.22 -172.33 -176.22 -172.97 -175.56 -172.33 -175.56 -173.61 -176.89 -173.61 -176.89 -174.26 -176.89 -174.91 -177.56 -174.91 -177.56 -174.91 -176.22 -174.91 -176.22 -175.56 -177.56 -175.56 -176.22 -174.91 -176.89 -176.22 -176.89 -175.56 -171.08 -176.22 -177.56 -176.22 -177.56 -176.22 -177.56 -176.22 -175.56 -176.22 -177.56 -176.22 -177.56 -175.56 -177.56 -179.60 -175.56 -178.23 -177.56 -176.22 -177.56 -176.22 -172.97 -178.23 -175.56 -178.23 -175.56 -175.56 -176.89 -171.08 -175.56 -178.23 -175.56 -178.23 -175.56 -177.56 -176.22 -177.56 -175.56 -178.23 -175.56 -177.56 -175.56 -177.56 -175.56 -177.56 -175.56 -177.56 -175.56 -177.56 -171.70 -177.56 -174.91 -178.23 -174.91 -177.56 -174.91 -177.56 -174.26 -177.56 -174.26 -178.23 -174.91 -179.60 -174.26 -178.23 -174.26 -177.56 -174.26 -177.56 -175.56 -178.23 -174.26 -177.56 -173.61 -177.56 -175.56 -177.56 -174.26 -178.23 -174.91 -176.22 -174.26 -176.89 -174.91 -176.89 -174.26 -178.23 -172.97 -174.26 -172.97 -176.22 -172.97 -173.61 -172.33 -173.61 -172.97 -172.33 -174.26 -172.33 -172.97 -171.08 -174.26 -171.70 -174.91 -172.33 -173.61 -172.33 -174.26 -172.33 -174.91 -171.70 -175.56 -172.33 -175.56 -172.33 -176.22 -173.61 -176.22 -172.33 -175.56 -173.61 -176.89 -174.26 -176.22 -174.26 -177.56 -173.61 -176.89 -174.26 -176.89 -169.22 -175.56 -174.26 -175.56 -174.26 -171.70 -173.61 -176.22 -174.26 -176.22 -174.26 -171.70 -176.22 -174.26 -174.26 -176.22 -174.26 -173.61 -176.89 -174.26 -176.89 -174.26 -176.89 -174.26 -176.89 -174.26 -177.56 -174.26 -176.89 -173.61 -177.56 -174.26 -176.89 -175.56 -176.89 -174.26 -177.56 -174.26 -177.56 -173.61 -177.56 -172.33 -176.89 -174.26 -177.56 -174.26 -176.89 -169.84 -177.56 -174.91 -177.56 -174.26 -176.89 -168.62 -178.23 -176.22 -178.23 -175.56 -178.91 -174.26 -179.60 -175.56 -178.91 -176.22 -176.22 -175.56 -178.23 -174.91 -178.23 -174.91 -178.23 -175.56 -178.91 -177.56 -176.89 -176.22 -176.89 -176.22 -178.91 -173.61 -177.56 -175.56 -176.89 -175.56 -177.56 -176.22 -171.08 -175.56 -177.56 -176.22 -177.56 -176.89 -177.56 -176.89 -176.22 -175.56 -177.56 -176.22 -176.89 -176.22 -176.89 -175.56 -175.56 -178.23 -177.56 -176.22 -177.56 -176.22 -178.23 -178.23 -175.56 -178.23 -176.22 -176.22 -177.56 -176.22 -174.91 -178.23 -176.22 -178.91 -176.22 -178.91 -178.23 -176.22 -175.56 -178.91 -175.56 -178.23 -175.56 -178.23 -175.56 -171.70 -176.22 -178.23 -175.56 -176.22 -176.22 -178.23 -176.22 -172.97 -176.22 -178.91 -176.22 -178.91 -176.22 -178.23 -176.22 -173.61 -175.56 -178.91 -176.89 -178.91 -176.22 -178.23 -176.22 -171.08 -175.56 -178.23 -175.56 -178.91 -175.56 -178.23 -176.22 -179.60 -175.56 -178.23 -175.56 -178.23 -176.22 -178.23 -176.22 -178.91 -174.91 -178.91 -175.56 -178.23 -176.22 -178.23 -176.89 -178.23 -174.91 -178.91 -174.91 -178.23 -174.91 -178.23 -174.26 -178.23 -174.26 -177.56 -174.26 -178.23 -173.61 -178.91 -174.91 -177.56 -174.26 -178.23 -172.33 -178.23 -174.91 -178.23 -175.56 -177.56 -173.61 -178.23 -175.56 -178.23 -174.91 -177.56 -174.91 -174.26 -174.91 -177.56 -174.91 -177.56 -175.56 -173.61 -174.91 -176.22 -174.91 -176.22 -174.91 -177.56 -174.91 -176.22 -174.91 -175.56 -174.26 -174.91 -176.89 -175.56 -174.26 -175.56 -174.91 -174.26 -176.22 -174.26 -176.89 -174.26 -173.61 -174.91 -176.89 -174.26 -176.89 -174.26 -176.89 -174.26 -177.56 -174.26 -176.89 -174.91 -176.89 -174.26 -177.56 -174.91 -178.23 -174.91 -177.56 -172.33 -178.23 -174.26 -178.23 -174.26 -178.91 -174.91 -176.89 -174.91 -178.23 ];
vel2=vel(1:500);
u2= -1.5*u;
%zona 3. [0,4]. Escogemos u=2
vel=[67.64 81.52 87.13 97.45 109.01 112.95 124.01 130.57 137.06 143.79 147.41 154.19 157.83 165.05 164.47 172.97 175.56 179.60 182.39 186.75 189.78 192.11 200.32 196.95 200.32 205.59 203.80 204.69 209.26 208.33 213.07 216.01 214.04 216.01 216.01 218.02 219.04 225.36 221.11 224.28 222.16 224.28 227.55 228.66 226.45 226.45 229.78 227.55 233.21 229.78 232.05 229.78 227.55 233.21 234.38 235.55 232.05 233.21 233.21 237.94 236.74 233.21 237.94 234.38 235.55 234.38 234.38 236.74 233.21 240.38 235.55 226.45 235.55 239.16 237.94 240.38 236.74 240.38 235.55 239.16 235.55 237.94 236.74 236.74 236.74 240.38 242.88 241.62 237.94 237.94 236.74 239.16 237.94 234.38 239.16 241.62 244.14 245.42 240.38 239.16 239.16 237.94 237.94 244.14 241.62 239.16 242.88 239.16 244.14 237.94 242.88 232.05 241.62 242.88 239.16 240.38 240.38 236.74 249.34 242.88 240.38 240.38 240.38 234.38 240.38 244.14 242.88 239.16 241.62 240.38 241.62 240.38 242.88 241.62 239.16 244.14 239.16 244.14 246.71 244.14 244.14 240.38 241.62 245.42 242.88 244.14 248.02 241.62 240.38 240.38 248.02 244.14 242.88 240.38 241.62 239.16 239.16 245.42 244.14 239.16 241.62 240.38 245.42 232.05 244.14 241.62 240.38 244.14 240.38 244.14 241.62 239.16 245.42 240.38 240.38 246.71 244.14 245.42 240.38 241.62 246.71 244.14 245.42 248.02 239.16 241.62 240.38 249.34 242.88 241.62 241.62 241.62 249.34 244.14 241.62 241.62 240.38 242.88 240.38 246.71 240.38 240.38 242.88 240.38 246.71 240.38 240.38 242.88 242.88 245.42 244.14 242.88 242.88 240.38 245.42 240.38 244.14 242.88 240.38 244.14 239.16 242.88 246.71 244.14 245.42 239.16 242.88 245.42 232.05 249.34 242.88 240.38 241.62 240.38 248.02 242.88 241.62 240.38 240.38 241.62 240.38 245.42 241.62 240.38 242.88 239.16 241.62 244.14 244.14 242.88 240.38 245.42 244.14 242.88 245.42 242.88 245.42 240.38 241.62 248.02 242.88 244.14 240.38 242.88 240.38 240.38 248.02 240.38 241.62 240.38 240.38 249.34 244.14 246.71 240.38 240.38 240.38 244.14 245.42 239.16 242.88 241.62 240.38 242.88 245.42 242.88 246.71 244.14 244.14 240.38 240.38 245.42 241.62 248.02 240.38 240.38 240.38 239.16 248.02 242.88 245.42 240.38 239.16 242.88 245.42 245.42 242.88 244.14 242.88 240.38 244.14 244.14 244.14 246.71 239.16 245.42 240.38 241.62 246.71 240.38 244.14 242.88 241.62 241.62 244.14 249.34 240.38 241.62 240.38 245.42 249.34 241.62 242.88 241.62 240.38 242.88 245.42 241.62 240.38 240.38 242.88 245.42 245.42 241.62 240.38 244.14 236.74 239.16 245.42 245.42 244.14 240.38 246.71 245.42 244.14 244.14 241.62 246.71 245.42 245.42 249.34 241.62 245.42 241.62 241.62 249.34 241.62 246.71 241.62 242.88 246.71 240.38 246.71 241.62 242.88 246.71 241.62 241.62 241.62 242.88 232.05 249.34 250.67 241.62 242.88 242.88 245.42 252.02 241.62 244.14 242.88 245.42 250.67 241.62 242.88 241.62 244.14 250.67 242.88 242.88 241.62 245.42 250.67 240.38 242.88 237.94 240.38 250.67 241.62 242.88 241.62 240.38 250.67 249.34 249.34 241.62 240.38 244.14 245.42 246.71 241.62 240.38 244.14 245.42 246.71 241.62 241.62 242.88 245.42 246.71 241.62 241.62 242.88 241.62 246.71 246.71 246.71 242.88 241.62 245.42 245.42 245.42 244.14 240.38 245.42 245.42 242.88 244.14 241.62 246.71 245.42 245.42 244.14 240.38 245.42 240.38 234.38 248.02 241.62 246.71 241.62 241.62 246.71 240.38 245.42 241.62 242.88 248.02 245.42 246.71 241.62 242.88 242.88 232.05 249.34 240.38 241.62 240.38 240.38 249.34 241.62 241.62 241.62 240.38 249.34 244.14 249.34 240.38 241.62 242.88 244.14 246.71 240.38 240.38 242.88 244.14 245.42 241.62 240.38 242.88 ];
vel3=vel(1:500);
u3= 2*u;
%a continuación, la gráfica ante distintas entradas
figure
plot(t,vel1,t,vel2,t,vel3)
grid
%procedemos a usar ident() para hallar las TFs
load('Funciones_de_transferencia');
%load('FT_2polo_1zero')
Gm1=tf(tf1.numerator/tf1.denominator(end),tf1.denominator/tf1.denominator(end));
Gm2=tf(tf2.numerator/tf2.denominator(end),tf2.denominator/tf2.denominator(end));
Gm3=tf(tf3.numerator/tf3.denominator(end),tf3.denominator/tf3.denominator(end));
hold on
%load('Gms');
lsim(Gm1,u1,t);
lsim(Gm2,u2,t);
lsim(Gm3,u3,t);
grid
hold off
%De la gráfica anterior se observa que el modelado es correcto.
%% Exp 1. c) Diseño del controlador. Primer orden
%Para los siguientes requerimientos:
%     ess=0
%     Mp<=15%
%     Tss<=1.2 seg
%Dado que se requiere un ess=0, debemos hacer uso de un integrador, es
%decir, tendremos un polo en el origen. 
%Para los 3 caso, usaremos un controlador PI el cual  tiene un polo en el
%origen y un cero
%El cero lo ubicaremos entre el polo del origen y el polo de la planta, de
%esta manera si analizamos el LGR podemos ver que no existiran polos
%complejos
%Dado que no existirán polos complejos, el polo deseado será
Tes=1;
polo_des=-4/Tes;
%Tener en cuenta que el polo deseado es -4, y para lograr los requerimientos 
%es necesario que el cero sea menor que el polo deseado

%A continuación, propondremos distintos ceros para cada zona y hallamos el
%K adecuado, analizando el LGR, para que el polo dominante sea el polo
%deseado

%Sea Gc1=Kp1+Ki1/s;
s=tf('s');

%%%%Zona 1
fprintf('\nZona 1\n')
%Establecemos un valor de cero en magnitud
zero=8;
%obtenemos los parametros de la ft de la planta
tau=Gm1.den{1}(1);
K=Gm1.num{1}(end);
%Hallamos el Kp del LGR con la sgte formula
Kp1=(-polo_des*(tau*polo_des+1))/(K*(polo_des+zero));
%definimos el modelo del controlador para hallar los polos del sistema con
%la funcion rlocus()
Gc1=(s+zero)/s;
polos_sistema=rlocus(Gc1*Gm1,Kp1);
%verificamos que el polo -4 sea dominante, para ello el otro polo debe ser
%5 veces mas alejado (referencia: debe ser menos a -20)
disp(polos_sistema)
%finalmente establecemos el controlados
Ki1=zero*Kp1;
Gc1=Kp1+Ki1/s;
display(Kp1)
display(Ki1)

%Zona 2
fprintf('\nZona 2\n')
%Establecemos un valor de cero en magnitud
zero=8;
%obtenemos los parametros de la ft de la planta
tau=Gm2.den{1}(1);
K=Gm2.num{1}(end);
%Hallamos el Kp del LGR con la sgte formula
Kp2=(-polo_des*(tau*polo_des+1))/(K*(polo_des+zero));
%definimos el modelo del controlador para hallar los polos del sistema con
%la funcion rlocus()
Gc2=(s+zero)/s;
polos_sistema=rlocus(Gc2*Gm2,Kp2);
%verificamos que el polo -4 sea dominante, para ello el otro polo debe ser
%5 veces mas alejado (referencia: debe ser menos a -20)
disp(polos_sistema)
%finalmente establecemos el controlados
Ki2=zero*Kp2;
Gc2=Kp2+Ki2/s;
display(Kp2)
display(Ki2)

%Zona 3
fprintf('\nZona 3\n')
%Establecemos un valor de cero en magnitud
zero=8;
%obtenemos los parametros de la ft de la planta
tau=Gm3.den{1}(1);
K=Gm3.num{1}(end);
%Hallamos el Kp del LGR con la sgte formula
Kp3=(-polo_des*(tau*polo_des+1))/(K*(polo_des+zero));
%definimos el modelo del controlador para hallar los polos del sistema con
%la funcion rlocus()
Gc3=(s+zero)/s;
polos_sistema=rlocus(Gc3*Gm3,Kp3);
%verificamos que el polo -4 sea dominante, para ello el otro polo debe ser
%5 veces mas alejado (referencia: debe ser menos a -20)
disp(polos_sistema)
%finalmente establecemos el controlados
Ki3=zero*Kp3;
Gc3=Kp3+Ki3/s;
display(Kp3)
display(Ki3)

%% Diseño controlador. 2do orden
%Al ver el LGR basta con un controlador P
Tes=1;
polo_des=-40;

Kp1=-polyval(Gm1.den{1},polo_des)/polyval(Gm1.num{1},polo_des);
roots=rlocus(Gm1,Kp1);
display(Kp1)
display(roots)

Kp2=-polyval(Gm2.den{1},polo_des)/polyval(Gm2.num{1},polo_des);
roots=rlocus(Gm2,Kp2);
display(Kp2)
display(roots)

Kp3=-polyval(Gm3.den{1},polo_des)/polyval(Gm3.num{1},polo_des);
roots=rlocus(Gm3,Kp3);
display(Kp3)

%% Procedemos a realizar la simulacion en SimuLink

